# Umbraco.Cms.Integrations.Crm.Dynamics

This integration provides a form picker and rendering component for forms managed within a Microsoft Dynamics 365 Marketing instance.

## Prerequisites

Required minimum versions of Umbraco CMS: 
- 8.4.0 for version 8
- 9.0.1 for version 9
- 10.1.0 for version 10

## How To Use

### Authentication

The package uses the OAuth protocol for authentication.

### Additional Configuration

To connect to your Dynamics 365 instance, the following configuration is required:
```
  <appSettings>
    ...
    <add key="Umbraco.Cms.Integrations.Crm.Dynamics.HostUrl" value="https://[INSTANCE]/api.crm4.dynamics.com/" />
    <add key="Umbraco.Cms.Integrations.Crm.Dynamics.ApiPath" value="api/data/v9.2/" />
    ...
  </appSettings>
```
```
    "Integrations": {
        "Crm": {
          "Dynamics": {
            "Settings": {
              "HostUrl": "https://[INSTANCE].crm4.dynamics.com/",
              "ApiPath": "api/data/v9.2/"
            }
          }
        }
      }
```

Please note that the above settings are for demonstration purpose, they might suffer changes depending on your personalized instance Web API.

### Backoffice usage

To use the form picker, a new data type should be created based on the Dynamics Form Picker property editor.

The settings in `Web.config` will be used for sending authorization and data requests to the Dynamics API, through the _0Auth Proxy for Umbraco Integrations_ or directly.

The _Connect_ button prompts the user with the Microsoft authorization window, which after a succesfull authentication will send the authorization code back.
The retrieved access token will be saved into the database and used for future requests.

_Revoke_ action will remove the access token from the database and the authorization process will need to be repeated.

### Front-end rendering

A strongly typed model will be generated by the property value converter, and an HTML helper is available, to easily render the form on the front-end.

Ensure your template has a reference to the following using statement:

```
@using Umbraco.Cms.Integrations.Crm.Dynamics.Helpers;
```

And render the form using (assuming a property based on the created data type, with alias `dynamicsForm` has been created):

```
@Html.RenderDynamicsForm(Model.DynamicsForm)
```

The selected form is embedded either through an _iframe_, or using JS scripts.

## Authorization Workflow
Starting with version 1.2.0 of the integration, the OAuth flow can be configured to use different Authorization Servers without requests routed through the `OAuth Proxy for Umbraco Integrations`.

### Configuration
To use the new setup, the following configuration is used:
```
<appSettings>
...
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.HostUrl" value="https://[INSTANCE].crm4.dynamics.com/" />
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.ApiPath" value="api/data/v9.2/" />
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.UseUmbracoAuthorization" value="true" />
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.ClientId" value="[YOUR_CLIENT_ID]" />
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.ClientSecret" value="[YOUR_CLIENT_SECRET]" />
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.RedirectUri" value="https://[YOUR_WEBSITE_BASE_URL]/umbraco/api/dynamicsauthorization/oauth" />
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.Scopes" value="https://[INSTANCE].crm4.dynamics.com/.default" />
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.AuthorizationEndpoint" value="https://login.microsoftonline.com/common/oauth2/v2.0/authorize" />
  <add key="Umbraco.Cms.Integrations.Crm.Dynamics.TokenEndpoint" value="https://login.microsoftonline.com/common/oauth2/v2.0/token" />
...
</appSettings>
```

or, 

```
 "Umbraco": {
    "CMS": {
      "Integrations": {
        "Crm": {
          "Dynamics": {
            "Settings": {
              "HostUrl": "https://[INSTANCE].crm4.dynamics.com/",
              "ApiPath": "api/data/v9.2/",
              "UseUmbracoAuthorization": true
            },
            "OAuthSettings": {
              "ClientId": "[YOUR_CLIENT_ID]",
              "ClientSecret": "[YOUR_CLIENT_SECRET]",
              "RedirectUri": "https://[YOUR_WEBSITE_BASE_URL]/umbraco/api/dynamicsauthorization/oauth",
              "AuthorizationEndpoint": "https://login.microsoftonline.com/common/oauth2/v2.0/authorize",
              "TokenEndpoint": "https://login.microsoftonline.com/common/oauth2/v2.0/token",
              "Scopes": "https://[INSTANCE].crm4.dynamics.com/.default"
            }
          },
        }
      }
    }
  }
```

### Configuration Breakdown
- ClientId - client id of your own app
- ClientSecret - client secret of your own app
- RedirectUri - endpoint for Authorization controller that will receive the authorization code from the auth server
- AuthorizationEndpoint - provider URL for handling authorization
- TokenEndpoint - provider URL for retrieving access tokens

### Implementation
The `UseUmbracoAuthorization` flag will toggle between the default Umbraco authorization service and the custom one that will use your private configuration.

`UmbracoAuthorizationService` provides the same implementation as on the previous versions of the package, while the `AuthorizationService` builds a custom authorization flow based on the provided settings.

Both implement `IDynamicsAuthorizationService` endpoint and provide the required endpoints for building the authorization URL and retrieving the acces token.

The `AuthorizationImplementationFactory` is used to load the proper injected authorization service.

`DynamicsAuthorizationController` with its `OAuth` action will handle the response from the Authorization Server and send the proper message to the client using the `window.opener` interface.