# Umbraco.Cms.Integrations.Crm.Hubspot

This integration provides a form picker and rendering component for forms managed within a [Hubspot](https://www.hubspot.com/) account.

## Prerequisites

Required minimum versions of Umbraco CMS: 
- 8.5.4 for version 8
- 9.0.1 for version 9
- 10.0.0 for version 10
- 11.0.0 for version 11

## How To Use

### Authentication

The package uses the OAuth protocol for authentication or private access tokens (if you are using a private app installed on your HubSpot account).

### Additional Configuration

To support multi-region HubSpot forms, the following app settings are required:
- Umbraco 8 `web.config`:
```
  <appSettings>
    ...
    <add key="Umbraco.Cms.Integrations.Crm.Hubspot.ApiKey" value="[your_private_app_access_token]" />
    <add key="Umbraco.Cms.Integrations.Crm.Hubspot.Region" value="[region]" />
    ...
  </appSettings>
```
- Umbraco 9+ `appsettings.json`:
```
"Integrations": {
  "Crm": {
    "Dynamics": {
      "Settings": {
        "ApiKey": "[your_private_app_access_token]",
        "Region": "[region]"
      }
    }
  }
}
```

For example, in Europe, a setting of `eu1` should be used.

### Backoffice usage

#### Note:
**As of November 30, 2022, HubSpot API is accessible using a private app access token or OAuth.**

To use the form picker, a new data type should be created based on the HubSpot Form Picker property editor.

The settings will be checked and a message presented indicating whether authenticiation is in place.

If OAuth is being used for authentication is available, then the _Connect_ button will be enabled, prompting the user when clicked, 
with the HubSpot authorization window.

The retrieved access token will be saved into the database and used for future requests.

_Revoke_ action will remove the access token from the database and the authorization process will need to be repeated.

If a private access token is used a message will be displayed notifying that access token is being used.

### Front-end rendering

A strongly typed model will be generated by the property value converter, and an HTML helper is available, to easily render the form on the front-end.

Ensure your template has a reference to the following using statement:

```
@using Umbraco.Cms.Integrations.Crm.Hubspot.Helpers;
```

And render the form using (assuming a property based on the created data type, with alias `hubSpotForm` has been created):

```
@Html.RenderHubspotForm(Model.HubspotForm)
```

## Authorization Workflow
Starting with version 2.1.0 of the integration, the OAuth flow can be configured to use different Authorization Servers without requests routed through the `OAuth Proxy for Umbraco Integrations`.

### Configuration
To use the new setup, the following configuration is used:
```
<appSettings>
...
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.Region" value="[REGION]" />
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.ApiKey" value="[YOUR_PRIVATE_APP_ACCESS_TOKEN]" />
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.UseUmbracoAuthorization" value="true" />
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.ClientId" value="[YOUR_CLIENT_ID]" />
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.ClientSecret" value="[YOUR_CLIENT_SECRET]" />
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.RedirectUri" value="https://[YOUR_WEBSITE_BASE_URL]/umbraco/api/hubspotauthorization/oauth" />
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.Scopes" value="[SCOPES]" />
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.AuthorizationEndpoint" value="[AUTHORIZATION_ENDPOINT]" />
  <add key="Umbraco.Cms.Integrations.Crm.Hubspot.TokenEndpoint" value="[TOKEN_ENDPOINT]" />
...
</appSettings>
```

or, 

```
 "Umbraco": {
    "CMS": {
      "Integrations": {
        "Crm": {
          "Hubspot": {
            "Settings": {
              "Region": "[REGION]",
              "ApiKey": "[YOUR_PRIVATE_APP_ACCESS_TOKEN]",
              "UseUmbracoAuthorization": true
            },
            "OAuthSettings": {
              "ClientId": "[YOUR_CLIENT_ID]",
              "ClientSecret": "[YOUR_CLIENT_SECRET]",
              "RedirectUri": "https://[YOUR_WEBSITE_BASE_URL]/umbraco/api/hubspotauthorization/oauth",
              "AuthorizationEndpoint": "[AUTHORIZATION_ENDPOINT]",
              "TokenEndpoint": "[TOKEN_ENDPOINT]",
              "Scopes": "[SCOPES]"
            }
          },
        }
      }
    }
  }
```

### Configuration Breakdown
- ClientId - client id of your own app
- ClientSecret - client secret of your own app
- RedirectUri - endpoint for Authorization controller that will receive the authorization code from the auth server
- AuthorizationEndpoint - provider URL for handling authorization
- TokenEndpoint - provider URL for retrieving access tokens

### Implementation
The `UseUmbracoAuthorization` flag will toggle between the default Umbraco authorization service and the custom one that will use your private configuration.

`UmbracoAuthorizationService` provides the same implementation as on the previous versions of the package, while the `AuthorizationService` builds a custom authorization flow based on the provided settings.

Both implement `IHubspotAuthorizationService` endpoint and provide the required endpoints for building the authorization URL and retrieving the acces token.

The `AuthorizationImplementationFactory` is used to load the proper injected authorization service.

`HubspotAuthorizationController` with its `OAuth` action will handle the response from the Authorization Server and send the proper message to the client using the `window.opener` interface.

### Developer Notes

To copy the front-end assets to the test site While in DEBUG mode, use following post build events:
```
  set UmbracoCmsIntegrationsTestsiteV8Path=$(SolutionDir)\Umbraco.Cms.Integrations.Testsite.V8
  set HubspotDir=%UmbracoCmsIntegrationsTestsiteV8Path%\App_Plugins\UmbracoCms.Integrations\Crm\Hubspot
  if not exist %HubspotDir% mkdir -p %HubspotDir%
  xcopy "$(ProjectDir)App_Plugins\UmbracoCms.Integrations\Crm\Hubspot" "%HubspotDir%" /e /y
```

